---
title: "Understanding the US Financial Services market"
author: "Darshan Sumant"
date: "February 17, 2019"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

## Project Inspiration

The innumerous stories of federal government employees living paycheck to paycheck and who are now forced to take drastic measures during the ongoing government shutdown inspired me to review why and how the banking and financial services system has failed the working class citizens in the largest economy in the world.

In this document, we explore existing data made available by the Consumer Financial Protection Bureau (CFPB) <https://www.consumerfinance.gov/>

>Data Sources include:
>
1. Home Mortgage Disclosure Act (HMDA) dataset <https://www.consumerfinance.gov/data-research/hmda/>
2. Mortgage Performance Trends <https://www.consumerfinance.gov/data-research/mortgage-performance-trends/download-the-data/>
3. National Financial Well-Being Survey <https://www.consumerfinance.gov/data-research/financial-well-being-survey-data/>
4. Consumer Complaint Database <https://www.consumerfinance.gov/data-research/consumer-complaints/>

#### Key Terms explained
>
(@) Asset
<br/>
A borrowing undertaken by an individual consumer from a lending institution such as a bank or a financial services firm, is called an asset.
<br/>
<br/>
Every asset is characterized by
>
>     (i) purpose (personal loan, auto loan, home mortgage, education loan, etc.)
>     (ii) amount (amount borrowed, also called 'principal')
>     (iii) rate of interest (profit rate for the lending institution)
>     (iv) borrowing period (tenor of the borrowing)
<br/>
<br/>
Typically, every asset has a pre-determined repayment amount due once a month, also known as the EMI (Equal Monthly Installment), which is calculate based on the borrowing amount, rate of interest, and borrowing period.
<br/>
<br/>
(@) Delinquent Asset
<br/>
<br/>
An asset is said to be delinquent if an EMI is more than 30 days overdue, i.e. the borrower is at least 30 days behind the pre-arranged repayment schedule. Since an EMI is due every month, i.e. about every 30 days, an asset being delinquent translates to 2 or more EMIs being missed.
<br/>
<br/>
(@) Non-Performing Asset (NPA)
<br/>
<br/>
An asset is deemed as "Non Performing" if the EMI is 90+ days overdue, i.e. the borrower is at least 90 days behind the repayment schedule. This translates to 4 or more EMIs being missed.
<br/>
<br/>
(@) Portfolio
<br/>
<br/>
A portfolio is a set of various individual borrowings (assets), that are typically monitored & managed together at an aggregate level. Portfolio performance is measured in terms of revenue (interest collection) & risk (delinquency, defaults, etc.). We focus on key risk indicators as below.
<br/>
<br/>
(@) Delinquency Rate
<br/>
<br/>
The amount corresponding to delinquent assets as a proportion to the total amount lent out is called the delinquency rate. Portfolio managers typically look at delinquency and other risk indicators calculated both by count and by volume. However, the measures by volume (asset value or the borrowed amount) is much more important, and is the same tracked and made available by the CFPB.
<br/>
<br/>
(@) NPA Rate
<br/>
<br/>
The amount corresponding to non-performing assets as a proportion to the total amount lent out is called the NPA rate.

```{r setup, include=FALSE}

# Load required packages
library("rmarkdown")
library("readr")
library("haven")
library("plyr")
library("dplyr")
library("tidyr")
library("stringr")
library("ggplot2")
library("zoo")
library("lubridate")
library("directlabels")
library("wesanderson")
library("ggmap")
library("maps")
library("mapdata")
library("openintro")
library("grid")
library("tools")
library("maptools")
library("lwgeom")

library("rgeos")
library("cowplot")
library("googleway")
library("ggrepel")
library("ggspatial")
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library("zipcode")

library("cartogram")
library("recmap")
library("scales")
library("gridExtra")
library("viridis")

register_google(key = "AIzaSyCvTsf9fTcIeH9d7WkTVxvYQzu80Hs-EvQ")

knitr::opts_chunk$set(echo=TRUE, 
                      message=FALSE, 
                      warning=FALSE, 
                      fig.width=12, 
                      fig.height=8)
```

```{r Define Theme}

# Ditch Axes (for Maps)
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  axis.title = element_blank()
  )

# Standard Theme
standard_theme <- theme(panel.background = element_rect(fill="NA", color="NA"),
  panel.border = element_rect(fill="NA",color="NA",size=5),
  panel.grid = element_blank(),
  plot.margin = margin(.5,.5,.5,.5, "cm"),
  plot.title = element_text(family="Times", 
                            face="bold",
                            size=20,
                            hjust=0.1),
  plot.subtitle = element_text(family="Times", 
                               face="italic",
                               size=14,
                               hjust=0.1),
  plot.caption = element_text(family="Times",
                              face="italic",
                              size=10,
                              hjust=0.5,
                              vjust=1.0),
  legend.background = element_rect(color="black"),
  legend.justification = "center",
  legend.text = element_text(size=rel(0.8))
  )

my_color_scale <- scale_color_gradient2(low="red",
                                        mid="white",
                                        high="green")
my_fill_scale <- scale_fill_gradient2(low="red",
                                      mid="white",
                                      high="green",
                                      breaks = c(0, .2, .4, .6, .8, 1))
```

```{r Load data, message=FALSE}

# Load Mortgage Performance data

## Delinquency (30-89 days overdue) Rates by month at County, State, State-Area type level 
del_county = read_csv("datasets/mortgage-performance/CountyMortgagesPercent-30-89DaysLate-thru-2018-06.csv")
del_state = read_csv("datasets/mortgage-performance/StateMortgagesPercent-30-89DaysLate-thru-2018-06.csv")
del_metro = read_csv("datasets/mortgage-performance/MetroAreaMortgagesPercent-30-89DaysLate-thru-2018-06.csv")

## Non-Performing Asset (90+ days overdue) Rates by month at County, State, State-Area type level
npa_county = read_csv("datasets/mortgage-performance/CountyMortgagesPercent-90-plusDaysLate-thru-2018-06.csv")
npa_state = read_csv("datasets/mortgage-performance/StateMortgagesPercent-90-plusDaysLate-thru-2018-06.csv")
npa_metro = read_csv("datasets/mortgage-performance/MetroAreaMortgagesPercent-90-plusDaysLate-thru-2018-06.csv")

# Load National Financial Well-Being Survey data
nfwbs_puf = read_csv("datasets/surveys/NFWBS_PUF_2016_data.csv")

# Load Consumer Complaints Data
complaints = read_csv("datasets/surveys/Consumer_Complaints.csv")

# Rectify column names
colnames(complaints) = gsub(" ", "_",colnames(complaints))
colnames(complaints) = gsub("-", "_",colnames(complaints))
colnames(complaints) = gsub("?", "",colnames(complaints))

```

```{r Convert data to long format, message=FALSE}

# Delinquency Rates
## Delinquency Rates by County
del_county_long <- gather(select(del_county, -c(RegionType, State, FIPSCode)),
                          key = Month,
                          value = delinquency_rate,
                          convert = TRUE,
                          -Name) %>% 
  mutate(Month = as.Date(paste(Month,"-01",sep="")),
         Mth = format(Month, "%b"))

## Delinquency Rates by State
del_state_long <- gather(select(del_state, -c(RegionType, FIPSCode)),
                         key = Month,
                         value = delinquency_rate,
                         convert = TRUE,
                         -Name) %>% 
  mutate(Month = as.Date(paste(Month,"-01",sep="")),
         Mth = format(Month, "%b"))

## Delinquency Rates by State & Area Type
del_metro_long <- gather(select(del_metro, -c(Name, CBSACode)),
                         key = Month,
                         value = delinquency_rate,
                         convert = TRUE,
                         -RegionType) %>% 
  mutate(Month = as.Date(paste(Month,"-01",sep="")),
         Mth = format(Month, "%b"))


# NPA Rates
## NPA Rates by County
npa_county_long <- gather(select(npa_county, -c(RegionType, State, FIPSCode)),
                          key = Month,
                          value = default_rate,
                          convert = TRUE,
                          -Name) %>% 
  mutate(Month = as.Date(paste(Month,"-01",sep="")),
         Mth = format(Month, "%b"))

## NPA Rates by State
npa_state_long <- gather(select(npa_state, -c(RegionType, FIPSCode)),
                         key = Month,
                         value = default_rate,
                         convert = TRUE,
                         -Name) %>% 
  mutate(Month = as.Date(paste(Month,"-01",sep="")),
         Mth = format(Month, "%b"))

## NPA Rates by State & Area Type
npa_metro_long <- gather(select(npa_metro, -c(Name, CBSACode)),
                         key = Month,
                         value = default_rate,
                         convert = TRUE,
                         -RegionType) %>% 
  mutate(Month = as.Date(paste(Month,"-01",sep="")),
         Mth = format(Month, "%b"))

```

```{r Group By AreaType & Month, message=FALSE}

# Month-on-month Delinquency Rates by Metro Area
del_by_metro <- del_metro_long %>% 
  group_by(RegionType, Month) %>%
  summarise(mean_del = mean(delinquency_rate),
            max_del = max(delinquency_rate),
            min_del = min(delinquency_rate),
            del_diff = max_del - min_del)


# Month-on-month NPA Rates by Metro Area
npa_by_metro <- npa_metro_long %>% 
  group_by(RegionType, Month) %>%
  summarise(mean_npa = mean(default_rate),
            max_npa = max(default_rate),
            min_npa = min(default_rate),
            npa_diff = max_npa - min_npa)

```

```{r Merge Delinquency & NPA rates, message=FALSE}

# Merge Delinquency rates and Default (NPA) rates by RegionType & Month
tot_by_metro <- merge(del_by_metro, npa_by_metro, by=c("RegionType", "Month"))

# Regress mean delinquency & default rates by Month & Region Type
tot_by_metro$pred.mean_del <- predict(lm(mean_del ~ format(Month, "%m") + RegionType, 
                                         data = tot_by_metro))
tot_by_metro$pred.mean_npa <- predict(lm(mean_npa ~ format(Month, "%m") + RegionType, 
                                         data = tot_by_metro))


```

## Performance Trends of Housing Mortgages

Since Housing is a basic need and because housing prices drive the local economy, we first analyze the housing loans or mortgages market. We will subsequently move on to analyze the auto loan and personal loan credit markets in due course of time.
<br/>
If a portfolio sees an increase in the risk factors discussed above, banks and financial services firms may reduce access to credit in the short term. We look at these risk indicators at 2 different geographic levels as below:
<br/>

* State-level (aggregating all mortgages in a state)
* Region Type (aggregating "metro"" or heavily urbanized areas within a state, and comparing these against the rest of the state)

### Delinquency Rates

Delinquency starts at 30 days overdue, and it is often an early indicator of financial stress. We see that
<br/>

i. mean delinquency rates follow a cyclic pattern or seasonality
delinquency is lowest at the start of a year (e.g., Feb '10 or Mar '11 or Feb '12) and increases gradually to hit the peak at the end of the year (e.g., Dec '10 or Dec '11 or Dec '12)
ii. mean delinquency rates in the non-metro areas mirrored those in the metro areas up to 2013, post which metro areas saw lower delinquencies compared to non-metro areas


```{r Plot 1}
# Plot delinquency trends by Region Type
p1 <- ggplot(filter(del_by_metro, grepl("Metro", RegionType)), 
             aes(x=Month, 
                 y=mean_del/100,
                 color=RegionType,
                 group=RegionType
                 )) + 
  geom_point() + 
  geom_line(size=2)

p1 + 
  labs(colour = "Region Type",
       x = "Year",
       y = "Mean Delinquency Rate [% overdue by 30-89 days]",
       title = "Delinquency rates have declined after an initial spike following the 2008 crisis",
       subtitle = "seasonality patterns in delinquency are clearly visible",
       caption = "source: Mortgage Performance data Jan '08 to Jun '18 published by CFPB (Jan '19)",
       tag = "A") + 
  scale_y_continuous(labels = scales::percent) + 
  scale_x_date(date_breaks = "1 year", 
               date_minor_breaks = "1 month",
               date_labels = "%Y",
               expand = c(0,0)) + 
  annotate("rect",
           xmin=as.Date("2013-04-01", "%Y-%m-%d"),
           xmax=as.Date("2018-12-01", "%Y-%m-%d"),
           ymin=0.0325,
           ymax=0.0345,
           alpha=0.2) + 
  annotate("text",
           x=as.Date("2016-02-01", "%Y-%m-%d"),
           y=0.0335,
           size=5,
           color="red",
           label="Metro & Non-Metro area trends have diverged since 2013") + 
  standard_theme + 
  theme(panel.grid.major = element_line(colour = "gray"),
        axis.text = element_text(colour = "black"),
        axis.ticks = element_line(size = 2),
        legend.position = c(0.825, 0.9),
        legend.background = element_rect(fill = "gray")) + 
  scale_color_manual(values=c('#440154ff','#21918dff'))

```

### Differences across States

After analyzing the difference between metro and non-metro areas, we examine the difference across states. We look at the worst (highest) delinquency in metro areas across states and compare against the best (lowest) delinquency in metro areas across states. Similarly, we look at the difference between the state with the highest delinquency in non-metro areas and the state with the lowest delinquency in non-metro areas. We see that
<br/>

i. there is again a clear cyclic or seasonal pattern
difference between worst and least delinquency is highest during December and January (around the winter & holiday season when borrowers may prioritize other imminent expenses over repaying their mortgages) and the difference decreases over the next 3-4 months before increasing again
ii. difference is higher for metro areas in every single month
this indicates higher disparity across states when we consider only the metro or heavily urbanized areas, as against the countryside

```{r Plot 2}

# Plot disparity in delinquency (max - min) across states
p2 <- ggplot(filter(del_by_metro, grepl("Metro", RegionType)),
             aes(x=format(Month, "%m"),
                 y=del_diff/100,
                 fill=RegionType)) + 
  geom_boxplot()

p2 + labs(colour = "Region Type", 
          x = "Month",
          y = "Disparity in delinquency rate (worst State - best State)", 
          title = "Delinquency disparity across states is largely due to Metro Areas",
          subtitle = "there is a subtle seasonal pattern even in delinquency disparity",
          caption = "source: Mortgage Performance data Jan '08 to Jun '18 published by CFPB (Jan '19)",
          tag = "B") + 
  scale_y_continuous(labels = scales::percent) + 
  scale_x_discrete("Month",
                   labels=month.abb
                   ) + 
  standard_theme + 
  theme(axis.ticks = element_line(size = 2),
        legend.position = c(0.35, 0.9),
        legend.background = element_rect(fill = "gray"),
        legend.direction = "horizontal"
        ) + 
  scale_fill_manual(values=c('#440154ff','#21918dff'))
```

## Comparing trends in Delinquency & NPA rates

When we compare delinquency and NPA rates, we see that delinquency rates differ across metro and non-metro areas, but NPA rates remain comparable. This may indicate a differential debt collections approach and focus between metro and non-metro areas.

```{r Plot 3, message=FALSE}

# Mean Delinquency Trends
p3a <- ggplot(filter(del_by_metro, grepl("Metro", RegionType)), 
              aes(x=Month, 
                  y=mean_del/100,
                  color=RegionType,
                  group=RegionType
                  )) + 
  geom_line(linetype = 2) + 
  geom_point(size=2) + 
  geom_smooth(aes(y=mean_del/100, group=RegionType), size=2) + 
  scale_y_continuous(labels = scales::percent) + 
  scale_x_date(date_breaks = "1 year", 
               date_minor_breaks = "1 month",
               date_labels = "%Y") + 
  scale_color_manual(values=c('#440154ff','#21918dff')) + 
  standard_theme + 
  theme(legend.position = c(0.8, 0.9),
        legend.background = element_rect(fill = "gray"),
        legend.direction = "horizontal"
        ) + 
  labs(y = "Mean Delinquency Rate across States",
       title = "Delinquency trends for Metro & Non-Metro areas have been diverging since 2013",
       tag = "C"
       )

# Mean NPA Trends
p3b <- ggplot(filter(npa_by_metro, grepl("Metro", RegionType)), 
              aes(x=Month, 
                  y=mean_npa/100,
                  color=RegionType,
                  group=RegionType
                  )) + 
  geom_line(linetype = 2) + 
  geom_point(size=2) + 
  geom_smooth(aes(y=mean_npa/100, group=RegionType), size=2) + 
  scale_y_continuous(labels = scales::percent) + 
  scale_x_date(date_breaks = "1 year", 
               date_minor_breaks = "1 month",
               date_labels = "%Y") + 
  scale_color_manual(values=c('#440154ff','#21918dff')) + 
  standard_theme + 
  theme(legend.position = c(0.8, 0.9),
        legend.background = element_rect(fill = "gray"),
        legend.direction = "horizontal"
        ) + 
  labs(y = "Mean NPA Rate across States",
       title = "However NPA Rate trends have now converged"
       )

# Plot both one below the other
grid.arrange(p3a, p3b, nrow = 2,
             bottom = "This indicates uneven Debt Collection focus & disparate Credit Tightening across Metro & Non-Metro areas"
             )
```

## Examining Inter-State differences in Delinquency rates

A closer look at average delinquency rates by State indicates:

* Southern states have much higher mortgage delinquencies, as compared to the rest of the country
* Delinquencies in high population density areas such as New York, California, Illinois, Massachusetts, New Jersey are well below 3%

```{r Plot 4}

# Convert state names to lowercase 
del_state_long$Name <- tolower(del_state_long$Name)

# Month-on-month Delinquency Rates by State
del_by_state <- del_state_long %>% 
  mutate(Year = year(Month)) %>%
  group_by(Name, Year) %>%
  summarise(mean_del = mean(delinquency_rate),
            max_del = max(delinquency_rate),
            min_del = min(delinquency_rate),
            del_diff = max_del - min_del)


states <- map_data("state")

# Merge with Map Data
del_state_map <- merge(states, 
                       del_by_state %>% filter(Year >= 2014 &
                                                 Year <= 2017), 
                       sort = FALSE, 
                       by.x = "region", 
                       by.y = "Name")

p4<- ggplot(del_state_map, aes(long, lat)) + 
  geom_polygon(aes(fill = mean_del/100, group=group), color="white") + 
  coord_fixed(1.3) + 
  facet_wrap(~Year)

p4 + labs(colour = "Mean Delinquency Rate", 
          x = "",
          y = "", 
          title = "Mortgage delinquency is consistently higher in the Southern states",
          subtitle = "Mississippi has the highest mortgage delinquency for last 4 years (2014-17)",
          caption = "source: Mortgage Performance data Jan '08 to Jun '18 published by CFPB (Jan '19)",
          tag = "D") + 
  scale_fill_viridis_c(labels = percent) + 
  guides(fill=guide_legend(title="Mean Delinquency Rate", 
                           title.position = "left",
                           label.position = "right"
                           )) + 
  ditch_the_axes + 
  standard_theme + 
  theme(legend.position = "bottom", legend.box = "horizontal")
```

## Inter-State differences in NPA rates

NPA rates aggregated at the State level present a different picture:

* Among the Southern states, Florida has a much worse NPA rate (about 5%) as compared to Texas (about 2%)
* This indicates very different Delinquency to NPA flow rates across States, which in turn indicate towards disparity in Collections focus & effort by state

```{r Plot 5}

# Convert state names to lowercase 
npa_state_long$Name <- tolower(npa_state_long$Name)

# Month-on-month Delinquency Rates by State
npa_by_state <- npa_state_long %>% 
  mutate(Year = year(Month)) %>%
  group_by(Name, Year) %>%
  summarise(mean_npa = mean(default_rate),
            max_npa = max(default_rate),
            min_npa = min(default_rate),
            npa_diff = max_npa - min_npa)

# Merge with Map Data
npa_state_map <- merge(states, 
                       npa_by_state %>% filter(Year >= 2014 &
                                                 Year <= 2017), 
                       sort = FALSE, 
                       by.x = "region", 
                       by.y = "Name")

p5<- ggplot(npa_state_map, aes(long, lat)) + 
  geom_polygon(aes(fill = mean_npa/100, group=group), color="white") + 
  coord_fixed(1.3) + 
  facet_wrap(~Year)

p5 + labs(colour = "Mean NPA Rate", 
          x = "",
          y = "", 
          title = "Southern states show a rapid decline in NPA rates, as do NY, NJ, & PA",
          subtitle = "Collections focus & Credit tightening may have increased in the Southern states",
          caption = "source: Mortgage Performance data Jan '08 to Jun '18 published by CFPB (Jan '19)",
          tag = "E") + 
  scale_fill_viridis_c(labels = percent) + 
  guides(fill=guide_legend(title="Mean NPA Rate", 
                           title.position = "left",
                           label.position = "right"
                           )) + 
  ditch_the_axes + 
  standard_theme + 
  theme(legend.position = "bottom", legend.box = "horizontal")
```

## Insights from Consumer Complaints

The Consumer Financial Protection Bureau receives thousands of complaints from consumers every week, which are sent to the relevant banking or financial services provider for response. CFPB monitors every complaint for timely and accurate closure.

```{r Complaints data transformations, message=FALSE}

# Transform Date complaint received by CFPB
complaints$Date_received <- as.Date(complaints$Date_received, "%m/%d/%Y")
complaints$Year_received <- as.numeric(format(complaints$Date_received, "%Y"))
complaints$Month_received <- floor_date(complaints$Date_received, "month")

# Transform Date complaint sent by CFPB to Company
complaints$Date_sent_to_company <- as.Date(complaints$Date_sent_to_company, "%m/%d/%Y")
complaints$Year_sent_to_company <- as.numeric(format(complaints$Date_sent_to_company, "%Y"))
complaints$Month_sent_to_company <- floor_date(complaints$Date_sent_to_company, "month")

# Filter out only Mortgage-related complaints
mort_comp <- filter(complaints, 
                    Product == "Mortgage" & grepl("Conventional", Sub_product))

# Re-classify Complaint Types
mort_comp <- mort_comp %>% mutate(
  Issue_type = case_when(
    grepl("Appl", Issue) ~ "Accessibility",
    Issue == "Credit decision / Underwriting" ~ "Accessibility",
    Issue == "Struggling to pay mortgage" ~ "Stressed",
    grepl("collection", Issue) ~ "Stressed",
    grepl("escrow", Issue) ~ "Servicing",
    Issue == "Trouble during payment process" ~ "Servicing",
    TRUE ~ "Other"
    )
  )

```

```{r Aggregate Complaints by Category, State, Year}

# Count of complaints received by Issue Type & Month
mort_comp_by_issue <- mort_comp %>% 
  group_by(Issue_type, Month_received) %>%
  summarise(num_complaints = n())

# Count of complaints received by Issue Type & State every Year
mort_comp_by_state <- mort_comp %>% 
  group_by(Issue_type, State, Year_received) %>%
  summarise(num_complaints = n())

# Calculate %complaints by State that are Stress related
mort_comp_by_state <- mort_comp_by_state %>%
  group_by(State, Year_received) %>%
  #mutate(comp_perc = num_complaints / sum(num_complaints))
  mutate(comp_perc = ifelse(num_complaints >= 30,
                            num_complaints / sum(num_complaints),
                            -0.1))
```

### Trends in Mortgage related complaints

Complaints related to Mortgages received from 2012 indicate

* most complaints received are raised by well-meaning consumers self-reporting financial stress and indicating that they are falling behind on their monthly payments
* there is however a gradual decline in such complaints since late 2015

```{r Complaint trends}

# Plot monthly volume of complaints received by the CFPB
p7 <- ggplot(mort_comp_by_issue, 
             aes(x=Month_received,
                 y=num_complaints,
                 fill=Issue_type,
                 group=Issue_type)) + 
  geom_area() + 
  geom_line(aes(ymax=num_complaints),
            position = "stack")

p7 + labs(colour = "Complaint Type", 
          x = "Year",
          y = "No. of Consumer Complaints", 
          title = "Most complaints are associated with consumers facing financial stress",
          subtitle = "Volume of Stress related complaints has gradually decreased, in line with total volume of complaints",
          caption = "source: Consumer Complaints Database published by CFPB (updated daily)",
          tag = "F") + 
  scale_y_continuous(expand=c(0,0)) + 
  scale_x_date(date_breaks = "1 year", 
               date_minor_breaks = "1 month",
               date_labels = "%Y") + 
  scale_fill_manual(values=viridis::viridis(4),
                    labels=c("Other","Accessibility","Servicing","Stressed")) + 
  guides(fill=guide_legend(title="Complaint Category", 
                           title.position = "left",
                           label.position = "right"
                           )) + 
  annotate("rect",
           xmin=as.Date("2013-03-01", "%Y-%m-%d"),
           xmax=as.Date("2016-05-01", "%Y-%m-%d"),
           ymin=2000,
           ymax=2250,
           alpha=0.2) + 
  annotate("text",
           x=as.Date("2014-10-01", "%Y-%m-%d"),
           y=2125,
           size=4,
           color="red",
           label="2012 complaints were added to the CFPB database in 2013,\nthe spike seen in Q1'13 should therefore be ignored in context") + 
  standard_theme + 
  theme(axis.ticks = element_line(size = 2),
        legend.position = c(0.8, 0.9)
        )

```

### Comparing across States

Comparing complaints received across states we see that:

* Highly populous states such as New York, California, Illinois, Massachusetts, New Jersey receive complaints related to self-reported financial stress more than 40% of the time
* Even neighboring states vary widely, such as North Dakota (over 65%) compared to Montana (less than 20%)

```{r Self reporting proportion by State}

# Convert state names to full names in lowercase 
mort_comp_by_state$Statename <- tolower(abbr2state(mort_comp_by_state$State))

# Merge with Map Data
comp_state_map <- merge(states, 
                        mort_comp_by_state %>% filter(Issue_type == "Stressed" &
                                                        Year_received >= 2014 &
                                                        Year_received <= 2017),
                        sort = FALSE, 
                        by.x = "region", 
                        by.y = "Statename")

# Create discrete bins based on %complaints related to Financial Stress
comp_state_map$perc_stress <- cut(comp_state_map$comp_perc,
                                  breaks=c(0, 0.1, 0.2, 0.3, 0.4, 1.0),
                                  labels=c("0-10","10-20","20-30","30-40","40+"))

# Plot proportion of Stress related complaints by State
p8 <- ggplot(comp_state_map, aes(long, lat)) + 
  geom_polygon(aes(fill = perc_stress, group=group), color="black") + 
  coord_fixed(1.3) + 
  facet_wrap(~Year_received)

p8 + labs(colour = "%Complaints related to\n Financial Stress", 
          x = "",
          y = "", 
          title = "Falling behind on mortgage payments is the #1 concern across major states",
          subtitle = "Over 40% of consumer complaints received from NY, CA, NJ, MA over last 4 years pertain to financial stress\nFlorida has seen a consistent decline in proportion of stress related complaints",
          caption = "source: Consumer Complaints Database published by CFPB (updated daily)",
          tag = "G") + 
  scale_fill_viridis_d(drop=FALSE) + 
  guides(fill=guide_legend(title="%Complaints related \nto Financial Stress", 
                           title.position = "left",
                           label.position = "right"
                           )) + 
  ditch_the_axes + 
  standard_theme + 
  theme(legend.position = "bottom", legend.box = "horizontal")

```

## Diving deeper into New York, New Jersey, & Pennsylvania

```{r Replicate Analysis by County}

# County map data
counties <- map_data("county")

# Delinquency Rates by County, convert state & county names to lowercase
del_county_long <- gather(select(del_county, -c(RegionType, FIPSCode)),
                          key = Month,
                          value = delinquency_rate,
                          convert = TRUE,
                          -c(State, Name)) %>% 
  mutate(Month = as.Date(paste(Month,"-01",sep="")),
         Mth = format(Month, "%b"),
         region = tolower(abbr2state(State)),
         subregion = tolower(gsub("([A-Za-z]+).*",
                                  "\\1",
                                  Name)))

# Month-on-month Delinquency Rates by County Area
del_by_county <- del_county_long %>%
  mutate(Year = year(Month)) %>%
  group_by(region, subregion, Year) %>%
  summarise(mean_del = mean(delinquency_rate),
            max_del = max(delinquency_rate),
            min_del = min(delinquency_rate),
            del_diff = max_del - min_del)

# Merge with Map Data
del_county_map <- inner_join(counties, 
                             del_by_county %>% 
                               filter(region %in% c("new york", 
                                                    "new jersey", 
                                                    "pennsylvania") & 
                                        Year >= 2014 &
                                        Year <= 2017), 
                             by = c("region", "subregion"))

# Define Stata & County Level geographies
ne_df <- subset(states, region %in% c("new york", "new jersey", "pennsylvania"))
ne_county <- subset(counties, region %in% c("new york", "new jersey", "pennsylvania"))

# Define the base map
ne_base <- ggplot(data = ne_df, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(data = ne_county, color = "white", fill="gray", alpha=0.5) + 
  geom_polygon(color = "black", fill = "NA")

# Plot the Delinquency by County
p9 <- ne_base + 
  geom_polygon(data = del_county_map, 
               aes(fill = mean_del/100, group=group), color="white") + 
  coord_fixed(1.3) + 
  facet_wrap(~Year)

p9 + labs(colour = "Mean Delinquency Rate", 
          x = "",
          y = "", 
          title = "Philadelphia County stands out with highest mortgage delinquency rates across the 3 states",
          subtitle = "For the other counties in the region, the Mean Delinquency rates are fairly over the last 4 years (2014-17)",
          caption = "source: Mortgage Performance data Jan '08 to Jun '18 published by CFPB (Jan '19)",
          tag = "H") + 
  scale_fill_viridis_c(labels = percent) + 
  guides(fill=guide_legend(title="Mean Delinquency Rate", 
                           title.position = "left",
                           label.position = "right"
                           )) + 
  ditch_the_axes + 
  standard_theme + 
  theme(legend.position = "bottom", legend.box = "horizontal")

knitr::opts_chunk$set(echo=TRUE, 
                      message=FALSE, 
                      warning=FALSE, 
                      fig.width=12, 
                      fig.height=8)
```

### Examining potential Credit Tightening across New York, New Jersey, & Pennsylvania

```{r Read HMDA Applications Data}
# HMDA Loan Approvals data for NY, NJ, PA, CA, IL, TX, FL
hmda_states = read_csv("datasets/hmda/hmda_lar_large_states_14_17.csv")
```
```{r Calculate Approval & Booking Rates by County}
approved <- c("Loan originated","Application approved but not accepted")
booked <- c("Loan originated")

# Number of applications by Stata & Census Tract & Year
applied_county <- hmda_states %>% 
  group_by(state_name, county_name, as_of_year) %>% 
  summarise(applied = n())

# Number of Approved applications by Stata & Census Tract & Year
approved_county <- hmda_states %>% 
  filter(action_taken_name %in% approved) %>%
  group_by(state_name, county_name, as_of_year) %>% 
  summarise(approved = n())

# Number of Loands Originates / Final Booked by Stata & Census Tract & Year
booked_county <- hmda_states %>% 
  filter(action_taken_name %in% booked) %>%
  group_by(state_name, county_name, as_of_year) %>% 
  summarise(booked = n())

# Merge all together
process_rates_county <- applied_county %>% 
  left_join(approved_county, by = c("state_name", "county_name", "as_of_year")) %>% 
  left_join(booked_county, by = c("state_name", "county_name", "as_of_year")) %>% 
  mutate(approval_rate = approved/applied, 
         booking_rate = booked/approved, 
         reject_rate = 1 - approval_rate,
         abnb_rate = 1 - booking_rate,
         loan_success_rate = booked/applied
         )
```

```{r Plot Approval Rate by County}

# Map Data at State & County-level
states <- map_data("state")
counties <- map_data("county")

# Rectify State & County Names
process_rates_county <- process_rates_county %>%
  mutate(region = tolower(state_name),
         subregion = tolower(gsub("([A-Za-z]+).*",
                                  "\\1",
                                  county_name))
  )

# Define Stata & County Level geographies
ne_df <- subset(states, region %in% c("new york", "new jersey", "pennsylvania"))
ne_county <- subset(counties, region %in% c("new york", "new jersey", "pennsylvania"))

# Define the base map
ne_base <- ggplot(data = ne_df, mapping = aes(x = long, y = lat, group = group)) + 
  coord_fixed(1.3) + 
  geom_polygon(color = "black", fill = "gray")

# Join county map data with Process Rates
ne_rates <- inner_join(ne_county, 
                       process_rates_county %>% filter(applied >= 100), 
                       by = c("region","subregion"))

# Plot County-level Approval rates
ne_base + 
  labs(colour = "Mean Delinquency Rate", 
       x = "", 
       y = "", 
       title = "County-level Approval Rates for New Home Purchases are also unchanged in the last 4 years (2014-17)",
       subtitle = "Most densely populated counties have Mortgage Approval rates between 70%-90%",
       caption = "source: Home Mortgage Disclosure Act (HMDA) data 2014-17 published by CFPB",
       tag = "I") + 
  geom_polygon(data = ne_rates, 
               aes(fill = approval_rate),
               color = "white") +
  facet_wrap(~as_of_year) + 
  geom_polygon(color = "black", fill = NA) +
  scale_fill_viridis_c(labels = percent) + 
  ditch_the_axes + 
  standard_theme + 
  guides(fill=guide_legend(title="Mortgage Approval Rate", 
                           title.position = "left",
                           label.position = "right"
                           )) + 
  theme(legend.position = "bottom", legend.box = "horizontal")
```

## Impact on Property Tax collections

An increase in Financial Stress also leads to aggravated impact on the local economy. Consumers who fall behind on scheduled payments, are often forced to re-allocate their savings & downgrade their consumption. However, an often neglected secondary effect is the revenue loss to the local government, city or county. Reduced sales cause a dip in sales tax collections, while certain local governments may see a rise in Property Tax delinquencies as well. All such factors together cause additional stress to the City or County government's finances, and in turn on the investment into community development initiatives.

One such example is the Philadelphia County in Pennsylvania. Thanks to the property-level property tax assessments and delinquencies published by the City Government on the OpenDataPhilly portal, we can analyze potential impact of Financial Stress on local government revenues.

```{r Philly_Shapefiles}

# Use ggmap to get Philly maptile
ph_map <- get_map(location = "Philadelphia County, Pennsylvania")

# Load Parcel-level Delinquency Shapefile
phl_taxdel <- read_sf("datasets/Philly_Council_Districts_2016/real_estate_tax_delinquencies.shp")

# Load City Council Districts Shapefile
phl_dist <- read_sf("datasets/Philly_Council_Districts_2016/Council_Districts_2016.shp")

# Filter out Serious Tax Delinquencies
phl_taxdel <- subset(phl_taxdel, 
                     grepl("resid", building_1) & 
                       (principal_ >= 3000) &
                       (oldest_yea >= 2009) &
                       (is_actiona == "true")) 

# Calculate Centroids
phl_dist <- cbind(phl_dist, st_coordinates(st_centroid(phl_dist)))
phl_taxdel <- cbind(phl_taxdel, st_coordinates(st_centroid(phl_taxdel)))

# Nudge Centroid Labels on Y-axis
phl_dist$nudge_y <- 0
phl_dist$nudge_y[phl_dist$OBJECTID == 9] <- -1.0
phl_dist$nudge_y[phl_dist$OBJECTID == 10] <- -1.0
phl_dist$nudge_y[phl_dist$OBJECTID == 2] <- -1.0

# Nudge Centroid Labels on X-axis
phl_dist$nudge_x <- 0
phl_dist$nudge_x[phl_dist$OBJECTID == 4] <- 3.0
phl_dist$nudge_x[phl_dist$OBJECTID == 2] <- 2.5
phl_dist$nudge_x[phl_dist$OBJECTID == 6] <- 1.5
phl_dist$nudge_x[phl_dist$OBJECTID == 3] <- -1.5
phl_dist$nudge_x[phl_dist$OBJECTID == 10] <- 1.5
```

```{r Plot property tax delinquencies}

# Plot Districts on Top of Geocoded Maptile
ggmap(ph_map) +
  geom_sf(data = phl_dist,
          inherit.aes = FALSE,
          fill=NA,
          color="black",
          size = 1) +
  geom_sf(data = phl_taxdel,
          inherit.aes = FALSE,
          aes(fill=num_years_, 
              color=num_years_,
              size = total_asse)) + 
  scale_color_viridis_c("No. of Years\nTax unpaid",
                       alpha = 1,
                       breaks = c(0, 2, 4, 6, 8, 20),
                       labels=c("0", "<2", "2-4", "4-6", "6-8", "8+"),
                       guide=FALSE) +
  scale_fill_viridis_c("No. of Years\nTax unpaid",
                       alpha = 1,
                       breaks = c(0, 2, 4, 6, 8, 20),
                       labels=c("0", "<2", "2-4", "4-6", "6-8", "8+")) +
  scale_size_area("Property Value\n($ '000s)", 
                  trans = "identity",
                  breaks = c(0, 250000, 500000, 750000, 1000000),
                  labels = c("<250", "250-500", "500-750", "750-1000", "1000+")) +
  geom_label(data = phl_dist, inherit.aes = FALSE,
             aes(X, Y, label = OBJECTID), size = 5, fontface = "bold",
             alpha = 0.5,
             nudge_y = phl_dist$nudge_y,
             nudge_x = phl_dist$nudge_x) +
  coord_sf(xlim = c(-75.30, -74.95), ylim = c(39.85, 40.15), expand = TRUE) +
  labs(x = "",
       y = "", 
       title = "Serious Tax delinquencies in Center City\nDistricts tend to be more recent",
       subtitle = "Northern & Western suburban districts have properties with\ntaxes unpaid for 7+ years",
       caption = "source: Property Tax Delinquencies data (OpenDataPhilly.org)",
       tag = "J") + 
  guides(fill=guide_legend(title="No. of Years\nTax unpaid",
                           title.position = "left",
                           label.position = "right",
                           order = 0)) +
  ditch_the_axes + 
  standard_theme + 
  theme(legend.position = "bottom", legend.box = "horizontal")
```